<?php

declare(strict_types=1);

/**
 * 統計功能配置檔案
 *
 * 統一管理統計功能相關的所有配置參數
 * 包括快取策略、計算排程、資料保存期限等
 */
return [
    /*
    |--------------------------------------------------------------------------
    | 快取設定
    |--------------------------------------------------------------------------
    |
    | 統計功能的快取配置，包括各種統計類型的 TTL 設定
    |
    */
    'cache' => [
        // 快取 TTL 設定（秒）
        'ttl' => [
            'short' => 1800,    // 30 分鐘 - 用於即時性要求較高的統計
            'medium' => 3600,   // 1 小時 - 用於一般統計查詢
            'long' => 7200,     // 2 小時 - 用於相對穩定的統計數據
            'daily' => 86400,   // 24 小時 - 用於日報統計
            'weekly' => 604800, // 7 天 - 用於週報統計
        ],

        // 各統計類型專用 TTL
        'types' => [
            'overview' => 1800,     // 統計概覽 - 30 分鐘
            'posts' => 3600,        // 文章統計 - 1 小時
            'users' => 3600,        // 使用者統計 - 1 小時
            'sources' => 7200,      // 來源統計 - 2 小時
            'popular' => 1800,      // 熱門統計 - 30 分鐘
            'trends' => 3600,       // 趨勢統計 - 1 小時
        ],

        // 快取預熱設定
        'warmup' => [
            'enabled' => true,
            'ttl' => 7200, // 預熱資料 TTL - 2 小時
            'batch_size' => 100, // 批量預熱大小
        ],

        // 支援的快取標籤
        'supported_tags' => [
            'statistics',
            'overview',
            'posts',
            'users',
            'popular',
            'trends',
            'sources',
            'prewarmed',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | 計算排程設定
    |--------------------------------------------------------------------------
    |
    | 統計計算任務的排程配置
    |
    */
    'calculation' => [
        // 排程頻率設定（cron 格式）
        'schedule' => [
            'hourly' => '0 * * * *',      // 每小時整點
            'daily' => '0 2 * * *',       // 每日凌晨 2:00
            'weekly' => '0 3 * * 0',      // 每週日凌晨 3:00
            'monthly' => '0 4 1 * *',     // 每月 1 日凌晨 4:00
        ],

        // 計算任務設定
        'tasks' => [
            'max_execution_time' => 3600, // 最大執行時間（秒）
            'memory_limit' => '512M',      // 記憶體限制
            'batch_size' => 1000,          // 批次處理大小
            'retry_attempts' => 3,         // 失敗重試次數
            'retry_delay' => 60,           // 重試延遲（秒）
        ],

        // 並行處理設定
        'parallel' => [
            'enabled' => true,
            'max_workers' => 4,            // 最大工作進程數
            'lock_timeout' => 1800,        // 鎖定超時時間（秒）
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | 資料保存設定
    |--------------------------------------------------------------------------
    |
    | 統計資料的保存策略和清理政策
    |
    */
    'retention' => [
        // 快照保存期限（天）
        'snapshots' => [
            'hourly' => 7,      // 小時快照保存 7 天
            'daily' => 90,      // 日快照保存 90 天
            'weekly' => 365,    // 週快照保存 1 年
            'monthly' => 1095,  // 月快照保存 3 年
        ],

        // 自動清理設定
        'cleanup' => [
            'enabled' => true,
            'schedule' => '0 5 * * *',  // 每日凌晨 5:00 執行清理
            'batch_size' => 500,        // 批次清理大小
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | 效能與限制設定
    |--------------------------------------------------------------------------
    |
    | 效能調整和系統限制配置
    |
    */
    'performance' => [
        // API 查詢限制
        'api_limits' => [
            'max_date_range' => 90,     // 最大查詢日期範圍（天）
            'max_results' => 1000,      // 最大結果數量
            'default_limit' => 20,      // 預設分頁大小
        ],

        // 文章瀏覽追蹤限制
        'view_tracking' => [
            'rate_limits' => [
                'authenticated' => [
                    'requests' => 300,      // 每分鐘請求數
                    'window' => 60,         // 時間窗口（秒）
                ],
                'anonymous' => [
                    'requests' => 120,      // 每分鐘請求數
                    'window' => 60,         // 時間窗口（秒）
                ],
            ],
            'response_timeout' => 100,  // 回應超時限制（毫秒）
        ],

        // 資料庫查詢最佳化
        'database' => [
            'connection_timeout' => 30,     // 連線超時（秒）
            'query_timeout' => 60,          // 查詢超時（秒）
            'slow_query_threshold' => 2.0,  // 慢查詢閾值（秒）
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | 監控與日誌設定
    |--------------------------------------------------------------------------
    |
    | 統計功能的監控和日誌配置
    |
    */
    'monitoring' => [
        // 健康檢查設定
        'health_check' => [
            'enabled' => true,
            'cache_check_timeout' => 5,     // 快取檢查超時（秒）
            'database_check_timeout' => 10, // 資料庫檢查超時（秒）
            'warning_thresholds' => [
                'cache_hit_rate' => 80,     // 快取命中率警告閾值（%）
                'response_time' => 2000,    // 回應時間警告閾值（毫秒）
                'error_rate' => 5,          // 錯誤率警告閾值（%）
            ],
        ],

        // 統計資料記錄
        'stats_tracking' => [
            'enabled' => true,
            'metrics' => [
                'cache_operations',   // 快取操作統計
                'api_requests',       // API 請求統計
                'calculation_times',  // 計算時間統計
                'error_rates',        // 錯誤率統計
            ],
        ],

        // 日誌設定
        'logging' => [
            'level' => 'info',              // 日誌等級
            'max_files' => 30,              // 最大日誌檔案數
            'max_file_size' => '10M',       // 單個日誌檔案最大大小
            'rotation' => 'daily',          // 日誌輪轉頻率
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | 功能開關
    |--------------------------------------------------------------------------
    |
    | 各項統計功能的開關控制
    |
    */
    'features' => [
        'cache_enabled' => true,            // 快取功能
        'background_calculation' => true,   // 背景計算
        'real_time_tracking' => true,       // 即時追蹤
        'api_rate_limiting' => true,        // API 限流
        'auto_warmup' => true,              // 自動預熱
        'data_cleanup' => true,             // 自動清理
        'monitoring' => true,               // 監控功能
        'debug_mode' => false,              // 除錯模式
    ],

    /*
    |--------------------------------------------------------------------------
    | 環境特定設定
    |--------------------------------------------------------------------------
    |
    | 根據不同環境調整的設定
    |
    */
    'environment' => [
        'development' => [
            'cache' => [
                'ttl' => [
                    'short' => 300,  // 5 分鐘
                    'medium' => 600, // 10 分鐘
                    'long' => 1200,  // 20 分鐘
                ],
            ],
            'features' => [
                'debug_mode' => true,
                'auto_warmup' => false,
            ],
        ],
        
        'testing' => [
            'cache' => [
                'ttl' => [
                    'short' => 60,   // 1 分鐘
                    'medium' => 120, // 2 分鐘
                    'long' => 300,   // 5 分鐘
                ],
            ],
            'features' => [
                'background_calculation' => false,
                'auto_warmup' => false,
                'data_cleanup' => false,
            ],
        ],
    ],
];