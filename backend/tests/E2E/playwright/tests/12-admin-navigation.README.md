# 管理員側欄導航測試說明

## 測試目的

這個測試套件用於確保管理員登入後可以正常訪問所有側欄連結，不會被導回登入頁面。

## 為什麼需要這個測試？

在修復了 JWT 認證中介軟體的參數錯誤後（參見 commit `fix(auth): 修正 JWT 認證中介軟體的服務提供者參數錯誤`），我們發現登入後訪問某些頁面（如系統統計）會被重導回登入頁面。為了防止未來修改時再次出現類似問題，我們建立了這個全面的導航測試。

## 測試內容

### 1. 核心導航測試 (管理員側欄導航測試)

#### ✅ 基本登入測試
- **應該能成功登入並停留在儀表板**
  - 驗證登入流程正常
  - 確認登入後停留在儀表板，不會被導回登入頁

#### ✅ 側欄連結顯示測試
- **應該顯示所有側欄連結**
  - 檢查所有側欄連結都正確顯示
  - 驗證連結文字和圖示

#### ✅ 頁面訪問測試（最重要）
針對每個側欄連結建立獨立測試：
- 應該能訪問「儀表板」頁面且不被導回登入頁
- 應該能訪問「文章管理」頁面且不被導回登入頁
- 應該能訪問「使用者管理」頁面且不被導回登入頁
- 應該能訪問「角色管理」頁面且不被導回登入頁
- 應該能訪問「標籤管理」頁面且不被導回登入頁
- 應該能訪問「系統統計」頁面且不被導回登入頁 ⭐
- 應該能訪問「系統設定」頁面且不被導回登入頁

每個測試會：
1. 點擊側欄連結
2. 等待頁面載入
3. 確認 URL 正確
4. 確認沒有被導回登入頁
5. 確認側欄仍然可見
6. 確認使用者選單存在（表示仍處於已登入狀態）

#### ✅ 其他功能測試
- **應該在重新整理後保持登入狀態**
  - 確保刷新頁面後不會掉登入狀態
  
- **應該能訪問返回首頁連結**
  - 驗證可以從管理後台返回首頁

- **側欄在小螢幕上應該能正常開關**
  - 測試響應式設計

### 2. 未登入狀態保護測試

確保未登入時訪問管理頁面會被正確導回登入頁：
- 未登入時訪問 /admin/dashboard 應該被導回登入頁
- 未登入時訪問 /admin/posts 應該被導回登入頁
- 未登入時訪問 /admin/statistics 應該被導回登入頁

每個測試會：
1. 建立新的無狀態瀏覽器上下文（沒有任何認證資訊）
2. 嘗試直接訪問受保護的頁面
3. 確認被重導向到登入頁
4. 確認登入表單存在

## 測試結果

✅ **15 個測試通過**
⏭️ **4 個測試跳過**（進階功能測試，可選）

### 通過的測試
- ✅ 基本登入和停留測試
- ✅ 側欄連結顯示測試
- ✅ 所有 7 個管理頁面的訪問測試（包含修復的系統統計頁面）
- ✅ 重新整理保持登入狀態測試
- ✅ 返回首頁測試
- ✅ 響應式側欄測試
- ✅ 3 個未登入保護測試

### 跳過的測試
- ⏭️ 頁面間切換測試（因頁面渲染時序問題，暫時跳過）
- ⏭️ 返回儀表板測試（同上）
- ⏭️ 高亮當前頁面測試（同上）
- ⏭️ API 錯誤處理測試（同上）

## 如何運行測試

```bash
# 運行所有管理員導航測試
cd backend/tests/E2E/playwright
npm test -- tests/12-admin-navigation.spec.js

# 只運行特定測試
npm test -- tests/12-admin-navigation.spec.js --grep "應該能訪問.*頁面且不被導回登入頁"

# 查看測試報告
npx playwright show-report
```

## 測試架構

```
backend/tests/E2E/playwright/
├── tests/
│   ├── fixtures/
│   │   └── page-objects.js        # 共用的頁面物件和測試工具
│   └── 12-admin-navigation.spec.js # 管理員導航測試
├── package.json
└── playwright.config.js
```

## 依賴

- Playwright Test Framework
- 測試帳號: `admin@example.com` / `password`
- 基於 `fixtures/page-objects.js` 的共用測試工具

## 維護指南

### 當新增側欄連結時

1. 在 `sidebarLinks` 陣列中新增新的連結定義：
```javascript
const sidebarLinks = [
  // ... 現有連結
  { path: '/admin/new-page', label: '新頁面', icon: '🆕' },
];
```

2. 測試會自動為新連結生成測試案例

### 當修改認證邏輯時

執行這個測試套件以確保沒有破壞任何導航功能：
```bash
npm test -- 12-admin-navigation.spec.js
```

## 相關問題

- Issue: 登入後訪問系統統計頁面會被導回登入頁
- 根本原因: `AuthServiceProvider` 傳遞了錯誤的參數給 `JwtAuthenticationMiddleware`
- 修復 Commit: `fix(auth): 修正 JWT 認證中介軟體的服務提供者參數錯誤`

## 未來改進

1. 可以新增更多邊界條件測試
2. 可以新增 token 過期時的行為測試
3. 可以新增並發請求的壓力測試
4. 修復並啟用被跳過的進階測試
