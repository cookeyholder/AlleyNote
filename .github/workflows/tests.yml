name: æ¸¬è©¦

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: åŸ·è¡Œæ¸¬è©¦å¥—ä»¶
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Docker Compose
      run: |
        docker compose -f docker-compose.test.yml build
        docker compose -f docker-compose.test.yml up -d
        sleep 10

    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: docker compose -f docker-compose.test.yml exec -T php composer install

    - name: æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼
      run: docker compose -f docker-compose.test.yml exec -T php ./vendor/bin/phpcs --standard=PSR12 src tests

    - name: åŸ·è¡Œéœæ…‹åˆ†æ
      run: docker compose -f docker-compose.test.yml exec -T php ./vendor/bin/phpstan analyse src tests --level=max

    - name: åŸ·è¡Œæ¸¬è©¦
      run: |
        docker compose -f docker-compose.test.yml exec -T php ./vendor/bin/phpunit --coverage-clover coverage.xml
        docker cp $(docker compose -f docker-compose.test.yml ps -q php):/var/www/html/coverage.xml ./coverage.xml

    - name: æª¢æŸ¥æ¸¬è©¦è¦†è“‹ç‡é–€æª»
      run: |
        COVERAGE=$(docker compose -f docker-compose.test.yml exec -T php ./vendor/bin/phpunit --coverage-text | grep -oP '(?<=Lines:)[^%]*' | tr -d ' ')
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "æ¸¬è©¦è¦†è“‹ç‡ $COVERAGE% ä½æ–¼è¦æ±‚çš„ 80%"
          exit 1
        fi

    - name: ä¸Šå‚³æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true

    # - name: ç™¼é€æ¸¬è©¦çµæœé€šçŸ¥
    #   if: always()
    #   uses: appleboy/telegram-action@master
    #   with:
    #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
    #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #     format: markdown
    #     message: |
    #       ğŸ§ª *æ¸¬è©¦çµæœé€šçŸ¥*
          
    #       å°ˆæ¡ˆ: AlleyNote
    #       åˆ†æ”¯: ${{ github.ref_name }}
    #       ç‹€æ…‹: ${{ github.job.status == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
          
    #       æäº¤è€…: ${{ github.actor }}
    #       æäº¤è¨Šæ¯: ${{ github.event.head_commit.message }}
