name: ç¨‹å¼ç¢¼å“è³ª

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality:
    name: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Docker Compose
      run: |
        docker-compose build
        docker-compose up -d

    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: echo "å·²ç”± Dockerfile å®‰è£ç›¸ä¾å¥—ä»¶ï¼Œè·³éæ­¤æ­¥é©Ÿ"

    - name: æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼
      run: docker-compose exec -T php ./vendor/bin/phpcs --standard=PSR12 src tests

    - name: åŸ·è¡Œéœæ…‹åˆ†æ
      run: docker-compose exec -T php ./vendor/bin/phpstan analyse src tests --level=max

    - name: æª¢æŸ¥ç¨‹å¼ç¢¼è¤‡é›œåº¦
      run: docker-compose exec -T php ./vendor/bin/phpmd src,tests text cleancode,codesize,controversial,design,naming,unusedcode

    - name: æª¢æŸ¥é‡è¤‡ç¨‹å¼ç¢¼
      run: docker-compose exec -T php ./vendor/bin/phpcpd src tests

    - name: æª¢æŸ¥ç›¸ä¾å¥—ä»¶å®‰å…¨æ€§
      run: docker-compose exec -T php composer audit

    - name: SonarCloud æƒæ
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=alleynote
          -Dsonar.organization=your-org
          -Dsonar.sources=src
          -Dsonar.tests=tests
          -Dsonar.php.coverage.reportPaths=coverage.xml
          -Dsonar.php.tests.reportPath=test-report.xml

#    - name: ç™¼é€å“è³ªæª¢æŸ¥çµæœé€šçŸ¥
#      if: always()
#      uses: appleboy/telegram-action@master
#      with:
#        to: ${{ secrets.TELEGRAM_CHAT_ID }}
#        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#        format: markdown
#        message: |
#          ğŸ” *ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥çµæœ*
#          
#          å°ˆæ¡ˆ: AlleyNote
#          åˆ†æ”¯: ${{ github.ref_name }}
#          ç‹€æ…‹: ${{ job.status == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }}
#          
#          æäº¤è€…: ${{ github.actor }}
#          æäº¤è¨Šæ¯: ${{ github.event.head_commit.message }}
