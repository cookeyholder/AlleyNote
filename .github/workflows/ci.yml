permissions:
    contents: read
name: Continuous Integration

on:
    push:
        branches: [main, develop, feature/*]
    pull_request:
        branches: [main, develop]

jobs:
    tests:
        runs-on: ubuntu-latest
        name: Tests (PHP ${{ matrix.php-versions }})

        strategy:
            fail-fast: false
            matrix:
                php-versions: ["8.4"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php-versions }}
                  extensions: pdo, sqlite3, json, gd, curl
                  tools: composer, phpunit
                  coverage: xdebug

            - name: Cache Composer packages
              uses: actions/cache@v4
              with:
                  path: backend/vendor
                  key: ${{ runner.os }}-php-${{ matrix.php-versions }}-${{ hashFiles('backend/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-${{ matrix.php-versions }}-

            - name: Install dependencies
              working-directory: backend
              run: composer install --prefer-dist --no-progress --no-interaction

            - name: Setup SQLite database
              working-directory: backend
              run: |
                  echo "ğŸ—„ï¸ å»ºç«‹æ¸¬è©¦è³‡æ–™åº«..."
                  mkdir -p database
                  touch database/test.sqlite3
                  chmod 666 database/test.sqlite3

            - name: Setup environment configuration
              working-directory: backend
              run: |
                  echo "âš™ï¸ è¨­å®šæ¸¬è©¦ç’°å¢ƒé…ç½®..."
                  # ä½¿ç”¨ç¾æœ‰çš„ .env.testing æª”æ¡ˆä½œç‚ºåŸºç¤
                  if [ -f ".env.testing" ]; then
                    echo "âœ… ä½¿ç”¨ç¾æœ‰çš„ .env.testing é…ç½®"
                  else
                    echo "âŒ .env.testing æª”æ¡ˆä¸å­˜åœ¨ï¼Œå»ºç«‹åŸºæœ¬é…ç½®"
                    cat > .env.testing << 'EOF'
                  APP_NAME=AlleyNote
                  APP_ENV=testing
                  APP_DEBUG=true
                  DB_CONNECTION=sqlite
                  DB_DATABASE=":memory:"
                  JWT_ALGORITHM=HS256
                  JWT_ISSUER=alleynote-api-test
                  JWT_AUDIENCE=alleynote-client-test
                  JWT_ACCESS_TOKEN_TTL=3600
                  JWT_REFRESH_TOKEN_TTL=2592000
                  JWT_SECRET=test-secret-key-for-ci-only
                  EOF
                  fi

            - name: Run Composer Security Audit
              working-directory: backend
              run: |
                  echo "ğŸ” åŸ·è¡Œç›¸ä¾å¥—ä»¶å®‰å…¨æƒæ..."
                  composer audit --format=json > security-audit.json || {
                    echo "âŒ ç™¼ç¾å®‰å…¨æ¼æ´ï¼"
                    echo "è©³ç´°è³‡è¨Šï¼š"
                    composer audit
                    echo ""
                    echo "è«‹åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤æ›´æ–°å¥—ä»¶ï¼š"
                    echo "composer update"
                    exit 1
                  }
                  echo "âœ… ç›¸ä¾å¥—ä»¶å®‰å…¨æƒæé€šé"

            - name: Run code style check
              working-directory: backend
              run: |
                  if [ -f "vendor/bin/php-cs-fixer" ]; then
                    echo "ğŸ¨ åŸ·è¡Œç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥..."
                    composer cs-check
                  else
                    echo "âš ï¸  PHP-CS-Fixer æœªå®‰è£ï¼Œè·³éç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥"
                  fi

            - name: Run static analysis
              working-directory: backend
              run: |
                  if [ -f "vendor/bin/phpstan" ]; then
                    echo "ğŸ”¬ åŸ·è¡Œéœæ…‹åˆ†æ..."
                    composer analyse || true
                  else
                    echo "âš ï¸  PHPStan æœªå®‰è£ï¼Œè·³ééœæ…‹åˆ†æ"
                  fi

            - name: Run tests
              working-directory: backend
              run: |
                  if [ -f "vendor/bin/phpunit" ]; then
                    echo "ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
                    vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
                  else
                    echo "âš ï¸  PHPUnit æœªå®‰è£ï¼Œè·³éæ¸¬è©¦"
                  fi
