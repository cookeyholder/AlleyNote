name: Dependency Updates

on:
  schedule:
    # æ¯é€±äºŒæ—©ä¸Š 10:00 æª¢æŸ¥æ›´æ–°
    - cron: '0 10 * * 2'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Check and Update Dependencies
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        tools: composer

    - name: Install current dependencies
      run: composer install --no-dev --prefer-dist --no-progress --no-interaction

    - name: Check for security vulnerabilities
      id: security-check
      run: |
        echo "ğŸ” æª¢æŸ¥å®‰å…¨æ¼æ´..."
        if composer audit --format=json > security-audit.json; then
          echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          echo "âœ… æœªç™¼ç¾å®‰å…¨æ¼æ´"
        else
          echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ ç™¼ç¾å®‰å…¨æ¼æ´ï¼Œéœ€è¦æ›´æ–°"
          composer audit
        fi

    - name: Check for available updates
      id: update-check
      run: |
        echo "ğŸ” æª¢æŸ¥å¯ç”¨æ›´æ–°..."
        composer outdated --format=json > outdated.json 2>/dev/null || true
        
        if [ -s outdated.json ] && [ "$(jq -r '.installed | length' outdated.json 2>/dev/null)" != "0" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "âœ… ç™¼ç¾å¯ç”¨æ›´æ–°"
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æ‰€æœ‰å¥—ä»¶éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi

    - name: Create update branch
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        BRANCH_NAME="auto-update/dependencies-$(date +%Y%m%d-%H%M%S)"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
        
        git checkout -b $BRANCH_NAME

    - name: Update dependencies
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      run: |
        echo "ğŸ“¦ æ›´æ–°ç›¸ä¾å¥—ä»¶..."
        
        # å‚™ä»½ç¾æœ‰çš„ composer.lock
        cp composer.lock composer.lock.backup
        
        # æ›´æ–°å¥—ä»¶
        composer update --prefer-dist --no-progress --no-interaction
        
        # é‡æ–°åŸ·è¡Œå®‰å…¨æƒæ
        echo "ğŸ” é‡æ–°æª¢æŸ¥å®‰å…¨æ€§..."
        composer audit

    - name: Run tests
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      run: |
        echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦ç¢ºä¿æ›´æ–°ä¸æœƒç ´å£åŠŸèƒ½..."
        composer install --dev --prefer-dist --no-progress --no-interaction
        
        if [ -f "vendor/bin/phpunit" ]; then
          vendor/bin/phpunit || {
            echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œæ¢å¾©åŸå§‹ç‰ˆæœ¬"
            cp composer.lock.backup composer.lock
            composer install --no-dev --prefer-dist --no-progress --no-interaction
            exit 1
          }
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ¸¬è©¦ï¼Œè·³éæ¸¬è©¦æ­¥é©Ÿ"
        fi

    - name: Generate update report
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      run: |
        echo "ğŸ“„ ç”¢ç”Ÿæ›´æ–°å ±å‘Š..."
        
        cat > dependency-update-report.md << 'EOF'
        # ç›¸ä¾å¥—ä»¶æ›´æ–°å ±å‘Š
        
        ## æ›´æ–°æ™‚é–“
        $(date '+%Y-%m-%d %H:%M:%S')
        
        ## å®‰å…¨æ€§æƒæçµæœ
        EOF
        
        if [ "${{ steps.security-check.outputs.has_vulnerabilities }}" == "true" ]; then
          echo "âš ï¸ ç™¼ç¾å®‰å…¨æ¼æ´ï¼Œå·²é€éæ›´æ–°ä¿®å¾©" >> dependency-update-report.md
        else
          echo "âœ… æœªç™¼ç¾å®‰å…¨æ¼æ´" >> dependency-update-report.md
        fi
        
        echo "" >> dependency-update-report.md
        echo "## å¥—ä»¶æ›´æ–°æ¸…å–®" >> dependency-update-report.md
        
        if [ -f outdated.json ] && [ -s outdated.json ]; then
          jq -r '.installed[] | "- **\(.name)**: \(.version) â†’ \(.latest)"' outdated.json >> dependency-update-report.md 2>/dev/null || true
        fi
        
        echo "" >> dependency-update-report.md
        echo "## æ¸¬è©¦çµæœ" >> dependency-update-report.md
        echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼Œæ›´æ–°å®‰å…¨" >> dependency-update-report.md

    - name: Commit changes
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      run: |
        git add composer.lock dependency-update-report.md
        git commit -m "chore(ç›¸ä¾): è‡ªå‹•æ›´æ–°ç›¸ä¾å¥—ä»¶

        - åŸ·è¡Œå®‰å…¨æ€§æƒæä¸¦ä¿®å¾©ç™¼ç¾çš„æ¼æ´
        - æ›´æ–°éæœŸçš„å¥—ä»¶åˆ°æœ€æ–°ç©©å®šç‰ˆæœ¬
        - é€šéæ‰€æœ‰æ¸¬è©¦é©—è­‰
        
        è©³ç´°è³‡è¨Šè«‹æŸ¥çœ‹ dependency-update-report.md"

    - name: Create Pull Request
      if: steps.security-check.outputs.has_vulnerabilities == 'true' || steps.update-check.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.branch_name }}
        title: "ğŸ”’ è‡ªå‹•æ›´æ–°ç›¸ä¾å¥—ä»¶ - $(date +%Y/%m/%d)"
        body: |
          ## ğŸ“¦ ç›¸ä¾å¥—ä»¶è‡ªå‹•æ›´æ–°
          
          æ­¤ PR ç”±è‡ªå‹•åŒ–å·¥ä½œæµç¨‹å»ºç«‹ï¼Œç”¨æ–¼æ›´æ–°å°ˆæ¡ˆçš„ç›¸ä¾å¥—ä»¶ã€‚
          
          ### ğŸ” æª¢æŸ¥é …ç›®
          - âœ… å®‰å…¨æ€§æƒæ
          - âœ… å¥—ä»¶ç›¸å®¹æ€§æª¢æŸ¥
          - âœ… è‡ªå‹•åŒ–æ¸¬è©¦
          
          ### ğŸ“„ è©³ç´°å ±å‘Š
          è«‹æŸ¥çœ‹ `dependency-update-report.md` äº†è§£æ›´æ–°è©³æƒ…ã€‚
          
          ### ğŸš€ ä¸‹ä¸€æ­¥
          1. æª¢è¦–è®Šæ›´å…§å®¹
          2. åŸ·è¡Œé¡å¤–æ¸¬è©¦ï¼ˆå¦‚éœ€è¦ï¼‰
          3. åˆä½µæ­¤ PR
          
          ---
          *æ­¤ PR ç”± GitHub Actions è‡ªå‹•å»ºç«‹*
        labels: |
          dependencies
          security
          automated

    - name: Summary
      run: |
        if [ "${{ steps.security-check.outputs.has_vulnerabilities }}" == "true" ] || [ "${{ steps.update-check.outputs.has_updates }}" == "true" ]; then
          echo "âœ… ç›¸ä¾å¥—ä»¶æ›´æ–°å®Œæˆï¼Œå·²å»ºç«‹ Pull Request"
        else
          echo "â„¹ï¸ æ‰€æœ‰å¥—ä»¶éƒ½æ˜¯æœ€æ–°ä¸”å®‰å…¨çš„ç‰ˆæœ¬"
        fi
