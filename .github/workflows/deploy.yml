name: éƒ¨ç½²

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š PHP ç’°å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: pdo_sqlite, sqlite3, zip
        tools: composer:v2

    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: composer install --no-dev --prefer-dist --optimize-autoloader

    - name: å»ºç«‹ .env æª”æ¡ˆ
      run: |
        echo "${{ secrets.ENV_PRODUCTION }}" > .env

    - name: è¨­å®š SSH é‡‘é‘°
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: æ–°å¢éƒ¨ç½²ä¸»æ©Ÿåˆ°å·²çŸ¥ä¸»æ©Ÿ
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

    - name: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
      env:
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      run: |
        tar -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='tests' \
          --exclude='.github' \
          --exclude='*.log' \
          .
        scp deploy.tar.gz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
        ssh $DEPLOY_USER@$DEPLOY_HOST "cd $DEPLOY_PATH && \
          tar -xzf deploy.tar.gz && \
          rm deploy.tar.gz && \
          ./scripts/deploy.sh"

    - name: å»ºç«‹ç‰ˆæœ¬æ¨™ç±¤
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "éƒ¨ç½²ç‰ˆæœ¬: $VERSION"
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: å»ºç«‹ GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ env.version }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false

    # - name: ç™¼é€éƒ¨ç½²é€šçŸ¥
    #   if: always()
    #   uses: appleboy/telegram-action@master
    #   with:
    #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
    #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #     format: markdown
    #     message: |
    #       ğŸš€ *éƒ¨ç½²é€šçŸ¥*
          
    #       å°ˆæ¡ˆ: AlleyNote
    #       ç‰ˆæœ¬: ${{ env.version || 'latest' }}
    #       ç‹€æ…‹: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
          
    #       æäº¤è€…: ${{ github.actor }}
    #       æäº¤è¨Šæ¯: ${{ github.event.head_commit.message }}
