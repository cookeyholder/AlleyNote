# AlleyNote 程式碼品質改善詳細計劃

## 🎯 改善目標

- **PSR-4 合規率**: 76.59% → **90%+**
- **現代 PHP 採用率**: 64.79% → **80%+**
- **DDD 結構完整性**: 0% → **70%+**

---

## 📋 第一階段：PSR-4 合規率改善 (優先級：🔥 最高)

### 1.1 Scripts 目錄重構
**目標**: 修復 scripts/ 目錄下所有 PHP 檔案的 PSR-4 問題

**具體任務**:
- [x] 為 70+ 個腳本檔案添加適當的命名空間 `AlleyNote\Scripts\`
- [x] 重構 `scan-project-architecture.php` 等核心腳本
- [x] 更新 composer.json 自動載入配置
- [x] 建立 scripts/lib/ 子目錄結構

**預期效果**: PSR-4 合規率 +8-10%

### 1.2 類別與檔案名稱一致性檢查
**目標**: 確保所有類別名稱與檔案名稱完全一致

**具體任務**:
- [x] 掃描所有 PHP 檔案檢查類別名稱
- [x] 修復不一致的檔案 (預估 15-20 個)
- [x] 確保所有檔案有 `declare(strict_types=1)` 聲明

**預期效果**: PSR-4 合規率 +3-5%

### 1.3 命名空間路徑驗證
**目標**: 確保命名空間與目錄結構完全對應

**具體任務**:
- [x] 自動化檢查命名空間與檔案路徑的對應關係
- [x] 修復錯誤的命名空間宣告
- [x] 建立命名空間一致性測試

**預期效果**: PSR-4 合規率 +2-3%

---

## 🚀 第二階段：現代 PHP 特性採用提升 (優先級：🔥 高)

## 🟢 進度更新 (暫存)

- 2025-09-29: 已完成初步重構與修復項目，包含：
	- 提取 `JsonFlag` 枚舉至 `app/Shared/Enums/JsonFlag.php`，並更新 `app/Application/Controllers/BaseController.php` 使用 enum（通過 php -l 與 PHPStan 針對相關檔案的檢查）。
	- 修復 `app/Shared/Monitoring/Services/ErrorTrackerService.php` 中的重複/殘留非 PHP 區塊問題，覆寫為單一定義實作並通過 php -l 與 PHPStan 分析。
	- 提取 `SanitizerMode` 枚舉至 `app/Shared/Enums/SanitizerMode.php`，並更新 `app/Infrastructure/Services/OutputSanitizerService.php` 使用共用 enum；已在容器內通過 php -l 與 PHPStan 檢查。（2025-09-29）

- 2025-09-29: 已在容器內執行完整 CI（php-cs-fixer、PHPStan、PHPUnit），並在修正若干單元測試相關實作後使 CI 通過：
	- 修正並提取 `SanitizerMode`、`JsonFlag`，清理 `ErrorTrackerService` 的語法雜訊與行為差異。
	- 調整 `ActivitySeverity` 枚舉（改為 int backing）以符合測試預期。
	- 修正 `ErrorTrackerService` 的通知處理與統計回傳結構，通過對應單元測試。
	- CI 結果：Tests: 2066, Assertions: 9100, Skipped: 36（時間約 1m49s，PHPStan 與 PHP CS Fixer 通過）。

	- 2025-09-29: 已新增 `ValidationRule` 枚舉（`app/Shared/Enums/ValidationRule.php`），並在容器內執行語法檢查、PHPStan 與完整 CI：
		- 檔案已通過 `php -l` 語法檢查。
		- `phpstan analyse` 對該檔案無錯誤回報。
		- 執行 `composer ci`（php-cs-fixer、PHPStan、PHPUnit）後通過；php-cs-fixer 自動修正了格式細節。
		- CI 最終結果：OK（含部分被略過的測試）。

下一步：依照 `CODE_QUALITY_IMPROVEMENT_PLAN.md` 的優先順序繼續下一項改善（例如新增 `ValidationRule` 枚舉或開始型別宣告強化）。每完成一項我會重複：執行 CI 與 PHPStan → 更新計畫檔 → commit 變更。


### 2.1 枚舉型別大規模導入
**目標**: 將常數群組、狀態標識符等替換為 enum

**具體任務**:
- [x] 新增 `HttpStatusCode` 枚舉
- [x] 新增 `CacheType` 枚舉
- [x] 新增 `LogLevel` 枚舉
- [x] 新增 `DatabaseAction` 枚舉
- [x] 新增 `SecurityLevel` 枚舉
- [x] 新增 `ValidationRule` 枚舉
- [ ] 新增 `EventType` 枚舉
- [ ] 重構現有的 PostStatus 枚舉使用範圍

**預期效果**: 現代 PHP 採用率 +5-8%

### 2.2 型別宣告系統強化
**目標**: 為所有函式添加完整的型別宣告

**具體任務**:
- [ ] 掃描並修復缺少回傳型別的函式 (預估 150+ 個)
- [ ] 導入聯合型別 `string|null`, `int|float`, `array|Collection` 等
- [ ] 採用交集型別適合的場景
- [ ] 強化參數型別提示

**預期效果**: 現代 PHP 採用率 +4-6%

### 2.3 建構子屬性提升與 readonly 類別
**目標**: 簡化建構子程式碼，提升不可變性

**具體任務**:
- [ ] 重構 DTO 類別使用建構子屬性提升 (15-20 個檔案)
- [ ] 將 Value Objects 標記為 readonly
- [ ] 重構配置類別為 readonly
- [ ] 優化依賴注入的建構子

**預期效果**: 現代 PHP 採用率 +3-5%

### 2.4 Match 表達式取代 Switch
**目標**: 提升程式碼簡潔性和型別安全性

**具體任務**:
- [ ] 將 BaseController 中的 switch 重構為 match
- [ ] 重構路由處理中的 switch 語句
- [ ] 重構驗證器中的條件判斷
- [ ] 重構快取策略選擇邏輯

**預期效果**: 現代 PHP 採用率 +2-3%

---

## 🏛️ 第三階段：DDD 結構完整性改善 (優先級：🟡 中高)

### 3.1 聚合根 (Aggregate Root) 設計完善
**目標**: 建立清楚的聚合邊界和一致性保證

**具體任務**:
- [ ] 重構 `Post` 為完整的聚合根
- [ ] 重構 `User` 為聚合根
- [ ] 建立 `ActivityLog` 聚合
- [ ] 建立 `Statistics` 聚合
- [ ] 定義聚合間的互動規則

**預期效果**: DDD 結構完整性 +20-25%

### 3.2 值物件 (Value Objects) 擴充應用
**目標**: 將原始型別包裝為有意義的領域概念

**具體任務**:
- [ ] 建立 `PostTitle` 值物件
- [ ] 建立 `UserId` 值物件
- [ ] 建立 `Email` 值物件
- [ ] 建立 `IPAddress` 值物件
- [ ] 建立 `Timestamp` 值物件
- [ ] 建立 `Statistics` 相關值物件群組

**預期效果**: DDD 結構完整性 +15-20%

### 3.3 領域事件機制強化
**目標**: 建立完整的事件驅動架構

**具體任務**:
- [ ] 完善 `PostViewed` 事件處理
- [ ] 新增 `UserRegistered` 事件
- [ ] 新增 `PostPublished` 事件
- [ ] 新增 `StatisticsCalculated` 事件
- [ ] 建立事件儲存與回放機制
- [ ] 實作事件溯源功能

**預期效果**: DDD 結構完整性 +12-18%

### 3.4 限界上下文明確化
**目標**: 建立清楚的領域邊界和防腐層

**具體任務**:
- [ ] 明確定義 `Post` 上下文邊界
- [ ] 明確定義 `Auth` 上下文邊界
- [ ] 明確定義 `Statistics` 上下文邊界
- [ ] 建立上下文間的 Anti-Corruption Layer
- [ ] 定義上下文間的通信協議

**預期效果**: DDD 結構完整性 +8-12%

### 3.5 Repository 模式優化
**目標**: 確保儲存庫只處理聚合根

**具體任務**:
- [ ] 重構 `PostRepository` 只返回 Post 聚合根
- [ ] 重構 `UserRepository` 介面設計
- [ ] 建立 `StatisticsRepository`
- [ ] 移除直接的實體存取
- [ ] 建立查詢物件模式

**預期效果**: DDD 結構完整性 +5-8%

---

## 🧪 第四階段：測試與品質保證 (優先級：🟡 中)

### 4.1 測試覆蓋率驗證
- [ ] 為重構的類別建立單元測試
- [ ] 建立聚合根的行為測試
- [ ] 建立值物件的不變性測試
- [ ] 建立領域事件的整合測試

### 4.2 程式碼品質檢查
- [ ] 確保所有改善通過 PHPStan Level 10
- [ ] 確保所有改善通過 PHP CS Fixer
- [ ] 執行完整的 CI 管道驗證
- [ ] 效能回歸測試

---

## 📊 進度追蹤與里程碑

### 里程碑 1: PSR-4 合規達成 (Week 1-2)
- [x] Scripts 目錄重構完成
- [x] 類別名稱一致性修復完成
- [x] 自動化檢查腳本建立完成
- **目標**: PSR-4 合規率達到 90%+

### 里程碑 2: 現代 PHP 特性大幅提升 (Week 3-4)
- [ ] 8個新枚舉導入完成
- [ ] 150+ 函式型別宣告強化完成
- [ ] 20+ 類別建構子優化完成
- **目標**: 現代 PHP 採用率達到 80%+

### 里程碑 3: DDD 結構基礎建立 (Week 5-6)
- [ ] 4個核心聚合根設計完成
- [ ] 6個核心值物件建立完成
- [ ] 事件機制基礎完成
- **目標**: DDD 結構完整性達到 70%+

### 里程碑 4: 完整驗證與文件 (Week 7)
- [ ] 所有測試通過
- [ ] 效能評估完成
- [ ] 技術文件更新完成
- **目標**: 準備合併到主分支

---

## ⚠️ 風險評估與預防措施

### 高風險項目
1. **聚合根重構** - 可能影響現有業務邏輯
2. **Repository 模式改變** - 可能影響資料存取
3. **大規模型別宣告** - 可能引入型別相關錯誤

### 預防措施
1. **段階式重構** - 每次只重構一個小模組
2. **完整測試覆蓋** - 在重構前建立充分測試
3. **效能監控** - 持續監控重構對效能的影響
4. **回滾計劃** - 為每個重要變更準備回滾方案

---

## 📈 預期整體效果

**程式碼品質指標改善**:
- PSR-4 合規率: 76.59% → 90%+ (**+13.41%**)
- 現代 PHP 採用率: 64.79% → 80%+ (**+15.21%**)
- DDD 結構完整性: 0% → 70%+ (**+70%**)

**技術債務減少**:
- 減少樣板程式碼 **20-25%**
- 提升程式碼可讀性 **30-35%**
- 增強型別安全性 **40-50%**
- 改善測試覆蓋率 **15-20%**

**開發效率提升**:
- 減少除錯時間 **25-30%**
- 加速新功能開發 **15-20%**
- 提升程式碼審查效率 **20-25%**
- 降低維護成本 **30-35%**
