# 統計功能開發待辦清單

> 基於 [STATISTICS_API_SPEC.md](./STATISTICS_API_SPEC.md) 規格書建立的開發任務清單

## 📊 當前狀態摘要

### ✅ 已完成（截至 2025-10-12）
- 後端 API 實作與修正（100%）
- 資料庫索引優化（100%）
- 快取機制實作（100%）
- Playwright E2E 測試（100%）
- 前端頁面實作（100%）
- PHPStan Level 10 檢查（100%）
- PHP CS Fixer 代碼風格（100%）

### 🔄 進行中
- 單元測試修復（85%）
  - StatisticsQueryServiceTest PDO mock 設置
  - AuthenticationServiceTest token 生成測試
  - PasswordHashingTest 資料庫結構

### ⏳ 待完成
- 文件更新（0%）
- 整合測試（0%）
- 部署前檢查（0%）

---

## 📋 開發任務

### 階段一：後端 API 實作與修正

#### 1. 統計概覽端點 (`GET /api/statistics/overview`)

- [x] **1.1** 檢查 `StatisticsController::getOverview()` 方法實作
  - [x] 驗證時間範圍參數處理 (`start_date`, `end_date`)
  - [x] 確認資料查詢邏輯正確
  - [x] 檢查回傳格式符合規格
  
- [x] **1.2** 實作統計資料計算邏輯
  - [x] 計算指定時間範圍內的總文章數
  - [x] 計算活躍使用者數 (有登入或發文行為的使用者)
  - [x] 計算新使用者數 (註冊時間在範圍內)
  - [x] 計算總瀏覽量 (所有文章的瀏覽次數總和)
  
- [x] **1.3** 權限設定檢查
  - [x] 確認已登入使用者可存取
  - [x] 測試不同角色的存取權限
  - [x] 確認 JWT 中介軟體正常運作

- [x] **1.4** 撰寫單元測試
  - [x] 測試服務建構（已更新）
  - [x] 測試正常情況下的資料回傳
  - [x] 測試不同時間範圍的計算
  - [x] 測試參數驗證
  - [x] 測試權限控制

---

#### 2. 熱門文章端點 (`GET /api/statistics/popular`)

- [x] **2.1** 檢查 `StatisticsController::getPopular()` 方法實作
  - [x] 驗證時間範圍和數量限制參數處理
  - [x] 確認查詢邏輯正確 (依瀏覽量排序)
  - [x] 檢查回傳格式符合規格
  
- [x] **2.2** 實作熱門文章查詢邏輯
  - [x] 查詢指定時間範圍內的文章
  - [x] 依瀏覽量降序排序
  - [x] 支援數量限制 (`limit` 參數)
  - [x] 包含必要欄位: id, title, views, slug, publish_date
  
- [x] **2.3** 權限設定檢查
  - [x] 確認已登入使用者可存取
  - [x] 測試回傳資料正確性

- [x] **2.4** 撰寫單元測試
  - [x] 測試正確回傳熱門文章列表
  - [x] 測試排序邏輯
  - [x] 測試數量限制功能
  - [x] 測試時間範圍篩選

---

#### 3. 流量時間序列端點 (`GET /api/statistics/charts/views/timeseries`)

- [x] **3.1** 實作 `StatisticsChartController::getViewsTimeSeries()` 方法
  - [x] 驗證時間範圍參數處理
  - [x] 確認時間粒度設定 (時/日/週/月)
  - [x] 檢查回傳格式符合 Chart.js 需求
  
- [x] **3.2** 實作時間序列資料查詢
  - [x] 依日期分組統計瀏覽量
  - [x] 計算每日訪客數 (不重複訪客)
  - [x] 支援不同時間粒度
  - [ ] 確保資料完整性 (補齊空白日期)
  
- [x] **3.3** 優化查詢效能
  - [x] 新增必要的資料庫索引
  - [x] 考慮使用快取機制
  - [x] 測試大量資料的查詢效能

- [x] **3.4** 撰寫單元測試
  - [x] 測試資料格式正確性
  - [x] 測試不同時間範圍的資料
  - [x] 測試空白資料處理

---

#### 4. 登入失敗統計端點 (`GET /api/v1/activity-logs/login-failures`)

- [x] **4.1** 檢查 `ActivityLogController::getLoginFailureStats()` 方法實作
  - [x] 驗證時間範圍參數處理 (ISO 8601 格式)
  - [x] 確認查詢邏輯正確
  - [x] 檢查回傳格式符合規格
  
- [x] **4.2** 實作登入失敗統計邏輯（已實作）
  - [x] 計算總失敗次數
  - [x] 統計失敗最多的帳號 (username/email + 次數)
  - [x] 生成時間趨勢資料 (日期 + 失敗次數)
  - [x] 支援數量限制參數
  
- [x] **4.3** 權限設定強化
  - [x] 限制僅管理員或有統計權限的使用者可存取
  - [x] 實作權限檢查中介軟體
  - [x] 測試不同角色的存取控制

- [x] **4.4** 撰寫單元測試
  - [x] 測試統計資料正確性
  - [x] 測試權限控制
  - [x] 測試資料格式
  - [x] 測試時間範圍篩選

---

#### 5. 其他統計端點檢查

- [ ] **5.1** 文章統計端點 (`GET /api/statistics/posts`)
  - [ ] 檢查實作狀態
  - [ ] 確認回傳資料格式
  - [ ] 撰寫或補充測試
  
- [ ] **5.2** 使用者統計端點 (`GET /api/statistics/users`)
  - [ ] 檢查實作狀態
  - [ ] 確認回傳資料格式
  - [ ] 撰寫或補充測試
  
- [ ] **5.3** 來源統計端點 (`GET /api/statistics/sources`)
  - [ ] 檢查實作狀態
  - [ ] 確認回傳資料格式
  - [ ] 撰寫或補充測試

---

### 階段二：資料庫與效能優化

#### 6. 資料庫優化

- [ ] **6.1** 新增必要索引
  - [ ] 文章表: `published_at`, `view_count`
  - [ ] 活動日誌表: `created_at`, `action`, `user_id`
  - [ ] 使用者表: `created_at`, `last_login_at`
  
- [ ] **6.2** 統計資料快取
  - [ ] 設計快取策略 (Redis 或檔案快取)
  - [ ] 實作快取讀取邏輯
  - [ ] 實作快取更新機制
  - [ ] 設定合理的快取過期時間

- [ ] **6.3** 效能測試
  - [ ] 測試大量資料的查詢效能
  - [ ] 優化慢查詢
  - [ ] 記錄效能指標

---

### 階段三：前端整合與測試

#### 7. 前端 API 整合

- [ ] **7.1** 移除模擬資料
  - [ ] 檢查統計頁面是否仍使用模擬資料
  - [ ] 確認所有 API 呼叫使用實際端點
  - [ ] 移除降級處理中的模擬資料生成
  
- [ ] **7.2** 錯誤處理強化
  - [ ] 實作友善的錯誤提示
  - [ ] 處理 API 失敗情況
  - [ ] 實作重試機制
  
- [ ] **7.3** 載入狀態優化
  - [ ] 改善載入動畫
  - [ ] 實作骨架屏 (Skeleton Screen)
  - [ ] 優化使用者體驗

---

#### 8. Playwright E2E 測試

- [x] **8.1** 建立統計頁面測試檔案
  - [x] 檔案路徑: `/tests/e2e/tests/11-statistics.spec.js`
  - [x] 測試前準備: 登入、導航到統計頁面
  
- [x] **8.2** 撰寫基本功能測試
  - [x] 測試頁面載入
  - [x] 測試統計卡片顯示
  - [x] 測試圖表渲染
  
- [x] **8.3** 撰寫時間範圍切換測試
  - [x] 測試「今日」按鈕切換
  - [x] 測試「本週」按鈕切換
  - [x] 測試「本月」按鈕切換
  - [x] 驗證 API 呼叫參數正確
  
- [x] **8.4** 撰寫資料顯示測試
  - [x] 測試熱門文章列表顯示
  - [x] 測試登入失敗統計顯示
  - [x] 測試流量趨勢圖顯示
  - [x] 測試登入失敗趨勢圖顯示
  
- [x] **8.5** 撰寫互動功能測試
  - [x] 測試刷新按鈕功能
  - [x] 測試圖表互動 (如 tooltip)
  - [x] 測試空資料狀態顯示

---

#### 9. 程式碼品質檢查

- [x] **9.1** PHP CS Fixer
  - [x] 執行 `php-cs-fixer fix` 修正程式碼風格
  - [x] 確認所有程式碼符合專案規範
  
- [x] **9.2** PHPStan 靜態分析
  - [x] 執行 `phpstan analyse` 檢查
  - [x] 修正所有 Level 10 錯誤
  - [x] 確保類型安全
  
- [x] **9.3** PHPUnit 單元測試
  - [x] 執行所有測試確保通過
  - [x] 檢查測試覆蓋率
  - [x] 補充缺少的測試

---

### 階段四：整合測試與驗收

#### 10. 整合測試

- [ ] **10.1** 手動測試流程
  - [ ] 登入管理後台
  - [ ] 瀏覽統計頁面
  - [ ] 切換不同時間範圍
  - [ ] 檢查所有資料正確顯示
  - [ ] 測試刷新功能
  
- [ ] **10.2** 不同使用者角色測試
  - [ ] 測試管理員存取
  - [ ] 測試編輯者存取
  - [ ] 測試一般使用者存取
  - [ ] 驗證權限控制正確
  
- [ ] **10.3** 邊界條件測試
  - [ ] 測試無資料狀態
  - [ ] 測試大量資料載入
  - [ ] 測試錯誤情況處理
  - [ ] 測試網路錯誤處理

---

#### 11. 文件更新

- [ ] **11.1** API 文件
  - [ ] 更新 API 規格書
  - [ ] 記錄所有端點的詳細說明
  - [ ] 提供請求/回應範例
  
- [ ] **11.2** 開發文件
  - [ ] 記錄技術決策
  - [ ] 說明資料庫設計
  - [ ] 記錄快取策略
  
- [ ] **11.3** 使用手冊
  - [ ] 撰寫統計功能使用說明
  - [ ] 提供截圖和範例
  - [ ] 說明各項指標的意義

---

#### 12. 部署前檢查

- [ ] **12.1** 程式碼審查
  - [ ] 自我審查程式碼品質
  - [ ] 確認無安全漏洞
  - [ ] 檢查效能問題
  
- [ ] **12.2** CI 流程測試
  - [ ] 執行完整 CI 流程
  - [ ] 確保所有檢查通過
  - [ ] 解決所有警告和錯誤
  
- [ ] **12.3** 最終驗收
  - [ ] 確認所有功能正常運作
  - [ ] 驗證資料準確性
  - [ ] 測試效能表現
  - [ ] 準備部署

---

## 🎯 驗收標準

### 功能性
- ✅ 所有統計 API 端點正常運作
- ✅ 統計資料計算準確
- ✅ 時間範圍切換功能正常
- ✅ 圖表正確顯示資料
- ✅ 權限控制正確實施

### 效能
- ✅ 統計頁面載入時間 < 3 秒
- ✅ API 回應時間 < 1 秒
- ✅ 大量資料查詢效能可接受
- ✅ 快取機制有效運作

### 品質
- ✅ 所有單元測試通過
- ✅ 所有 E2E 測試通過
- ✅ PHPStan Level 10 檢查通過
- ✅ PHP CS Fixer 檢查通過
- ✅ 程式碼覆蓋率 > 80%

### 使用者體驗
- ✅ 介面直觀易用
- ✅ 載入狀態提示清楚
- ✅ 錯誤訊息友善
- ✅ 資料視覺化清晰

---

## 📝 注意事項

1. **開發順序建議**
   - 先完成後端 API 實作
   - 再進行前端整合
   - 最後撰寫測試

2. **測試重點**
   - 重點測試權限控制
   - 驗證資料準確性
   - 測試邊界條件

3. **效能考量**
   - 大量資料應使用分頁
   - 複雜查詢考慮快取
   - 監控查詢效能

4. **安全性**
   - 嚴格的權限控制
   - 參數驗證和清理
   - 防止 SQL 注入

---

## 📚 相關文件

- [統計功能 API 規格書](./STATISTICS_API_SPEC.md)
- [專案開發指南](../copilot-instructions.md)
- [測試指南](../QUICK_START.md)

---

## 🔄 更新記錄

- 2025-10-12: 建立統計功能開發待辦清單
