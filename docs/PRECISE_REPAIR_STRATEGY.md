# 精準修復策略文件

## 🎯 修復原則

基於第三輪開發循環的經驗教訓，制定以下保守且精準的修復策略：

### 1. 階段性修復 (Phase-by-Phase)
- **階段一**: 核心控制器修復 ✅ (已完成)
- **階段二**: 領域服務和 DTO 修復
- **階段三**: 基礎設施層修復
- **階段四**: 測試檔案修復
- **階段五**: 文件和配置修復

### 2. 修復優先級矩陣

| 層級 | 優先級 | 檔案類型 | 修復方式 |
|------|--------|----------|----------|
| 1 | 最高 | 控制器 | 手動修復 ✅ |
| 2 | 高 | 領域服務/DTO | 半自動+手動檢查 |
| 3 | 中 | 基礎設施 | 工具輔助修復 |
| 4 | 中低 | 測試檔案 | 批次修復+驗證 |
| 5 | 低 | 配置檔案 | 最後處理 |

### 3. 安全修復原則

#### ✅ 可以使用自動化的情況：
- 簡單的類型註釋修復
- 重複性高的模式匹配
- 明確定義的語法轉換

#### ❌ 禁止自動化的情況：
- 複雜的程式邏輯結構
- try-catch 塊重構
- OpenAPI 註解複雜語法
- 涉及業務邏輯的修改

### 4. 驗證檢查點

每個修復階段完成後必須通過：

1. **語法檢查**: `php -l` 無錯誤
2. **風格檢查**: `php-cs-fixer check` 無問題
3. **靜態分析**: PHPStan 錯誤數量減少
4. **基本測試**: 核心測試通過

### 5. 回滾機制

- 每階段修復前創建 git 分支
- 每個檔案修復前備份
- 發現問題立即回滾到上一個檢查點

## 📊 目前狀況評估

### ✅ 已完成項目
- **控制器修復**: 4個主要控制器已恢復到穩定狀態
  - PostController.php ✅
  - AuthController.php ✅
  - ActivityLogController.php ✅
  - AttachmentController.php ✅

### ⚠️ 待處理問題
- **語法錯誤檔案**: 107 個檔案有 linting 錯誤
- **PHPStan 錯誤**: 估計 1500+ 個靜態分析錯誤
- **測試失敗**: 預估 10-15 個測試可能失敗

### 📋 下一階段計畫

#### 階段二: 領域服務和 DTO 修復
**目標檔案** (依重要性排序):
1. `app/Domains/Auth/Services/AuthService.php`
2. `app/Domains/Auth/Services/JwtTokenService.php`
3. `app/Domains/Post/Services/PostService.php`
4. `app/Domains/Security/Services/ActivityLoggingService.php`
5. 各類 DTO 檔案 (CreatePostDTO, RegisterUserDTO 等)

**修復方法**:
- 使用保守型語法檢查工具
- 每個檔案修復後立即驗證
- 手動審查所有自動修復

#### 階段三: 基礎設施層修復
**目標檔案**:
- JWT 相關服務
- 路由系統
- 快取服務
- 資料庫相關

#### 階段四: 測試檔案批次修復
**策略**:
- 創建專門的測試檔案修復工具
- 批次處理但逐一驗證
- 確保測試邏輯不被破壞

## 🔧 工具改進計畫

### 新增工具需求
1. **保守型語法檢查器**: 僅修復明確的問題
2. **檔案備份管理器**: 自動備份和恢復
3. **階段性驗證器**: 每階段完成後自動檢查
4. **影響範圍分析器**: 評估修復可能的副作用

### 現有工具改進
- 修改現有批次修復工具，增加保守模式
- 添加詳細的修復日誌記錄
- 實施修復前後的差異比較

## 📈 成功指標

### 量化目標
- 語法錯誤檔案數: 107 → 0
- PHPStan 錯誤數: 1500+ → 800 以下
- 測試通過率: 提升至 99.5% 以上
- 程式碼風格: 維持 100% 符合規範

### 品質目標
- 無破壞性修復
- 保持程式邏輯完整性
- 維持測試覆蓋率
- 文件同步更新

## 🗓️ 執行時程

- **Day 1**: 階段二修復 (領域服務和 DTO)
- **Day 2**: 階段三修復 (基礎設施層)
- **Day 3**: 階段四修復 (測試檔案)
- **Day 4**: 階段五修復 (配置和文件)
- **Day 5**: 全面驗證和優化

這個策略確保每一步都是可控且可回滾的，避免重複第三輪的大規模破壞性修復問題。
