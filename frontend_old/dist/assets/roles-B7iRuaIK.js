import{r as e,b as n}from"./DashboardLayout-BjmJ-OJc.js";import{rolesAPI as t,permissionsAPI as s}from"./users-nxFUwfS-.js";import{t as o}from"./toast-ChPGQGGG.js";import{M as i}from"./Modal-oATPHkxR.js";import"./index-DHmEDfox.js";import"./vendor-core-DW9qjkZC.js";class r{constructor(){this.roles=[],this.permissions=[],this.groupedPermissions={},this.selectedRole=null,this.loading=!1}async init(){await this.loadRolesAndPermissions()}async loadRolesAndPermissions(){try{this.loading=!0,this.render();const[e,n]=await Promise.all([t.list(),s.listGrouped()]);this.roles=e.data||[],this.groupedPermissions=n.data||{},this.loading=!1,this.render()}catch(e){o.error("載入資料失敗"),this.loading=!1,this.render()}}render(){const t=`\n      <div class="max-w-7xl mx-auto">\n        <div class="flex items-center justify-between mb-8">\n          <h1 class="text-3xl font-bold text-modern-900">角色管理</h1>\n          <button \n            id="addRoleBtn" \n            class="px-6 py-3 bg-accent-600 text-white rounded-lg hover:bg-accent-700 transition-colors font-medium"\n          >\n            <i class="fas fa-plus mr-2"></i>\n            新增角色\n          </button>\n        </div>\n\n        ${this.loading?this.renderLoading():this.renderContent()}\n      </div>\n\n      \x3c!-- Modal 容器 --\x3e\n      <div id="modal-container"></div>\n    `;document.getElementById("app").innerHTML=e(t),n(),this.attachEventListeners()}renderLoading(){return'\n      <div class="bg-white rounded-2xl border border-modern-200 p-8">\n        <div class="text-center text-modern-500">\n          <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n          <p>載入中...</p>\n        </div>\n      </div>\n    '}renderContent(){return`\n      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">\n        \x3c!-- 角色列表 --\x3e\n        <div class="bg-white rounded-2xl border border-modern-200 p-6">\n          <h2 class="text-xl font-bold mb-4">角色列表</h2>\n          <div id="rolesListContainer" class="space-y-3">\n            ${this.renderRolesList()}\n          </div>\n        </div>\n\n        \x3c!-- 權限管理 --\x3e\n        <div class="bg-white rounded-2xl border border-modern-200 p-6">\n          <h2 class="text-xl font-bold mb-4">權限設定</h2>\n          <div id="permissionsContainer">\n            ${this.selectedRole?this.renderPermissionsEditor():'<p class="text-modern-500">請選擇一個角色來管理權限</p>'}\n          </div>\n        </div>\n      </div>\n    `}renderRolesList(){return 0===this.roles.length?'<p class="text-modern-500">尚無角色資料</p>':this.roles.map(e=>`\n      <div class="border border-modern-200 rounded-lg p-4 hover:border-accent-500 cursor-pointer transition-colors role-item"\n           data-role-id="${e.id}">\n        <div class="flex items-center justify-between">\n          <div>\n            <h3 class="font-bold text-lg">${this.escapeHtml(e.display_name||e.name)}</h3>\n            <p class="text-sm text-modern-600">${this.escapeHtml(e.description||"")}</p>\n          </div>\n          ${["超級管理員","super_admin"].includes(e.name)?"":`\n            <button \n              class="delete-role-btn text-red-600 hover:text-red-800 text-sm px-3 py-1"\n              data-role-id="${e.id}"\n              data-role-name="${this.escapeHtml(e.display_name||e.name)}"\n            >\n              刪除\n            </button>\n          `}\n        </div>\n      </div>\n    `).join("")}renderPermissionsEditor(){if(!this.selectedRole)return"";const{role:e,permission_ids:n}=this.selectedRole;let t="";for(const[s,o]of Object.entries(this.groupedPermissions))t+=`\n        <div class="mb-6">\n          <h3 class="font-bold text-lg mb-3 text-modern-700">${s}</h3>\n          <div class="space-y-2">\n            ${o.map(e=>`\n              <label class="flex items-center space-x-2">\n                <input\n                  type="checkbox"\n                  value="${e.id}"\n                  ${n.includes(e.id)?"checked":""}\n                  class="permission-checkbox rounded border-gray-300 text-accent-600 focus:ring-accent-500"\n                />\n                <span class="text-sm">${this.escapeHtml(e.display_name||e.name)}</span>\n                ${e.description?`<span class="text-xs text-gray-500">(${this.escapeHtml(e.description)})</span>`:""}\n              </label>\n            `).join("")}\n          </div>\n        </div>\n      `;return`\n      <div>\n        <div class="mb-4 pb-4 border-b">\n          <h3 class="text-lg font-bold">${this.escapeHtml(e.display_name||e.name)}</h3>\n          <p class="text-sm text-gray-600">${this.escapeHtml(e.description||"")}</p>\n        </div>\n        \n        <div class="max-h-96 overflow-y-auto mb-4">\n          ${t}\n        </div>\n        \n        <div class="flex justify-end space-x-3">\n          <button\n            id="cancelEditBtn"\n            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"\n          >\n            取消\n          </button>\n          <button\n            id="savePermissionsBtn"\n            class="px-4 py-2 bg-accent-600 text-white rounded-lg hover:bg-accent-700"\n            data-role-id="${e.id}"\n          >\n            儲存權限\n          </button>\n        </div>\n      </div>\n    `}attachEventListeners(){const e=document.getElementById("addRoleBtn");e&&e.addEventListener("click",()=>this.showRoleModal());document.querySelectorAll(".role-item").forEach(e=>{e.addEventListener("click",async n=>{if(n.target.closest(".delete-role-btn"))return;const t=parseInt(e.dataset.roleId);await this.selectRole(t)})});document.querySelectorAll(".delete-role-btn").forEach(e=>{e.addEventListener("click",async n=>{n.stopPropagation();const t=parseInt(e.dataset.roleId),s=e.dataset.roleName;await this.deleteRole(t,s)})});const n=document.getElementById("cancelEditBtn");n&&n.addEventListener("click",()=>{this.selectedRole=null,this.render()});const t=document.getElementById("savePermissionsBtn");t&&t.addEventListener("click",async()=>{const e=parseInt(t.dataset.roleId);await this.savePermissions(e)})}async selectRole(e){try{const n=await t.get(e);this.selectedRole=n.data,this.render()}catch(n){o.error("載入角色權限失敗")}}async savePermissions(e){const n=document.querySelectorAll(".permission-checkbox:checked"),s=Array.from(n).map(e=>parseInt(e.value));try{await t.updatePermissions(e,s),o.success("權限已更新")}catch(i){o.error("更新權限失敗")}}showRoleModal(e=null){const n=!!e,t=n?"編輯角色":"新增角色",s=`\n      <form id="roleForm" class="space-y-6">\n        <div>\n          <label for="role_name" class="block text-sm font-medium text-modern-700 mb-2">\n            角色名稱 *\n          </label>\n          <input\n            type="text"\n            id="role_name"\n            name="name"\n            value="${e?this.escapeHtml(e.name):""}"\n            class="w-full px-4 py-3 rounded-lg border border-modern-300 focus:outline-none focus:ring-2 focus:ring-accent-500"\n            required\n          />\n        </div>\n\n        <div>\n          <label for="role_display_name" class="block text-sm font-medium text-modern-700 mb-2">\n            顯示名稱 *\n          </label>\n          <input\n            type="text"\n            id="role_display_name"\n            name="display_name"\n            value="${e?this.escapeHtml(e.display_name||""):""}"\n            class="w-full px-4 py-3 rounded-lg border border-modern-300 focus:outline-none focus:ring-2 focus:ring-accent-500"\n            required\n          />\n        </div>\n\n        <div>\n          <label for="role_description" class="block text-sm font-medium text-modern-700 mb-2">\n            描述\n          </label>\n          <textarea\n            id="role_description"\n            name="description"\n            rows="3"\n            class="w-full px-4 py-3 rounded-lg border border-modern-300 focus:outline-none focus:ring-2 focus:ring-accent-500"\n          >${e?this.escapeHtml(e.description||""):""}</textarea>\n        </div>\n\n        <div class="flex justify-end gap-3 pt-4">\n          <button\n            type="button"\n            id="cancelModalBtn"\n            class="px-6 py-3 text-sm font-medium text-modern-700 border-2 border-modern-300 rounded-lg hover:bg-modern-50 transition-colors"\n          >\n            取消\n          </button>\n          <button\n            type="submit"\n            class="px-6 py-3 text-sm font-medium text-white bg-accent-600 rounded-lg hover:bg-accent-700 transition-colors"\n          >\n            ${n?"儲存變更":"新增角色"}\n          </button>\n        </div>\n      </form>\n    `,o=new i({title:t,content:s,size:"lg",showCancel:!1});o.show();const r=document.getElementById("roleForm");r&&r.addEventListener("submit",async t=>{t.preventDefault(),n?await this.handleUpdateRole(e.id,new FormData(r)):await this.handleCreateRole(new FormData(r)),o.hide()});const a=document.getElementById("cancelModalBtn");a&&a.addEventListener("click",()=>o.hide())}async handleCreateRole(e){try{const n={name:e.get("name"),display_name:e.get("display_name"),description:e.get("description")};await t.create(n),o.success("角色建立成功"),await this.loadRolesAndPermissions()}catch(n){o.error(n.message||"建立角色失敗")}}async handleUpdateRole(e,n){try{const s={name:n.get("name"),display_name:n.get("display_name"),description:n.get("description")};await t.update(e,s),o.success("角色更新成功"),await this.loadRolesAndPermissions()}catch(s){o.error(s.message||"更新角色失敗")}}async deleteRole(e,n){var s,i;if(confirm(`確定要刪除角色「${n}」嗎？此操作無法復原。`))try{await t.delete(e),o.success("角色已刪除"),await this.loadRolesAndPermissions(),this.selectedRole=null}catch(r){o.error((null==(i=null==(s=r.response)?void 0:s.data)?void 0:i.message)||"刪除角色失敗")}}escapeHtml(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e?String(e).replace(/[&<>"']/g,e=>n[e]):""}}export{r as default};
